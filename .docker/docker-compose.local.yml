version: '3.8'

services:
  # LLM Application (подключен к централизованной инфраструктуре)
  app:
    build:
      context: ../..
      dockerfile: .docker/containers/backend/Dockerfile
      args:
        - PYTHON_VERSION=${PYTHON_VERSION:-3.11}
        - INSTALL_GPU=${INSTALL_GPU:-false}
        - CUDA_VERSION=${CUDA_VERSION:-12.1.0}
    image: sop_llm:local
    container_name: sop_llm_app_local
    ports:
      - "${APP_PORT:-8200}:8000"      # API endpoint (согласно PORT_MAPPING.md)
      - "${METRICS_PORT:-8291}:9090"  # Prometheus metrics
    volumes:
      - ../../src:/app/src:rw
      - sop_llm_models_cache_local:/root/.cache/huggingface
      - sop_llm_app_logs_local:/app/logs
    networks:
      - sop_network
    env_file:
      - ./configs/.env.local
    environment:
      # Переопределяем для development
      - APP_ENV=development
      - DEBUG=true
      - LOG_LEVEL=INFO
      - PYTHONPATH=/app

      # PostgreSQL (подключение к централизованной инфраструктуре)
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-sop_admin}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-sop_llm_db}

      # Redis (подключение к централизованной инфраструктуре)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB:-1}  # DB 1 для sop_llm (0 для intake, 2 для s3)

      # Kafka (подключение к централизованной инфраструктуре)
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    stop_grace_period: 10s
    # Раскомментировать для GPU поддержки
    # runtime: nvidia
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        # Раскомментировать для GPU
        # reservations:
        #   devices:
        #     - driver: nvidia
        #       count: 1
        #       capabilities: [gpu]

networks:
  sop_network:
    external: true
    name: sop_network

volumes:
  sop_llm_models_cache_local:
    name: sop_llm_models_cache_local
  sop_llm_app_logs_local:
    name: sop_llm_app_logs_local
