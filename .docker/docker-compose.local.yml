# SOP LLM - Local Development Environment
# =============================================================================
# Только backend Python приложение для разработки
# Подключается к централизованной инфраструктуре (Redis в sop_infrastructure)
# =============================================================================

services:
  sop_llm:
    build:
      context: ..
      dockerfile: .docker/containers/backend/Dockerfile
      target: runtime-cpu
      args:
        - PYTHON_VERSION=${PYTHON_VERSION:-3.11}
    image: sop_llm:local
    container_name: sop_llm_local
    ports:
      - "${APP_PORT:-8200}:8000"
    volumes:
      # Исходники для hot-reload
      - ../src:/app/src:rw
      # Model presets (YAML конфиги)
      - ../config:/app/config:ro
      # Кэш моделей HuggingFace/Sentence-Transformers
      - sop_llm_models_cache_local:/root/.cache/huggingface
      # Логи приложения
      - sop_llm_logs_local:/app/logs
    networks:
      - sop_network
    env_file:
      - configs/.env.local
    environment:
      # Development overrides
      - APP_ENV=local
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - PYTHONPATH=/app

      # Redis (подключение к централизованной инфраструктуре)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-1}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/monitor/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    stop_grace_period: 10s
    # Loki logging labels для Promtail
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,env"
    labels:
      logging: "promtail"
      service: "sop_llm"
      env: "local"
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  # Langfuse - LLM Observability Platform
  # Использует общий PostgreSQL из sop_infrastructure (sop_postgres)
  # Используем v2 так как v3 требует ClickHouse
  langfuse:
    image: langfuse/langfuse:2
    container_name: sop_llm_langfuse
    ports:
      - "3001:3000"
    environment:
      # Database (PostgreSQL из sop_network)
      - DATABASE_URL=postgresql://sop_admin:change_me_in_production@sop_postgres:5432/langfuse
      # Auth
      - NEXTAUTH_SECRET=langfuse-secret-key-change-in-production
      - NEXTAUTH_URL=http://localhost:3001
      - SALT=langfuse-salt-change-in-production
      # Features
      - TELEMETRY_ENABLED=false
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=true
      # Auto-init (создаёт пользователя и проект при первом запуске)
      - LANGFUSE_INIT_ORG_ID=sop-local-org
      - LANGFUSE_INIT_ORG_NAME=SOP Local Development
      - LANGFUSE_INIT_PROJECT_ID=sop-llm-local
      - LANGFUSE_INIT_PROJECT_NAME=SOP LLM Service
      - LANGFUSE_INIT_PROJECT_PUBLIC_KEY=pk-lf-local-dev-public-key
      - LANGFUSE_INIT_PROJECT_SECRET_KEY=sk-lf-local-dev-secret-key
      - LANGFUSE_INIT_USER_EMAIL=admin@local.dev
      - LANGFUSE_INIT_USER_NAME=Local Admin
      - LANGFUSE_INIT_USER_PASSWORD=admin123
    networks:
      - sop_network
    depends_on:
      - sop_llm
    restart: unless-stopped

# Внешняя сеть (создаётся в sop_infrastructure)
networks:
  sop_network:
    external: true
    name: sop_network

volumes:
  sop_llm_models_cache_local:
    name: sop_llm_models_cache_local
  sop_llm_logs_local:
    name: sop_llm_logs_local
